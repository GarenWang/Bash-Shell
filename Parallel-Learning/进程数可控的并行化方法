# Language: bash
Njob=10    # 作业数目
Nproc=5    # 可同时运行的最大作业数

function CMD {        # 测试命令, 随机等待几秒钟
	n=$((RANDOM % 5 + 1))
	echo "Job $1 Ijob $2 sleeping for $n seconds ..."
	sleep $n
	echo "Job $1 Ijob $2 exiting ..."
}
function PushQue {    # 将PID压入队列
	Que="$Que $1"
	Nrun=$(($Nrun+1))
}
function GenQue {     # 更新队列
	OldQue=$Que
	Que=""; Nrun=0
	for PID in $OldQue; do
		if [[ -d /proc/$PID ]]; then
			PushQue $PID
		fi
	done
}
function ChkQue {     # 检查队列
	OldQue=$Que
	for PID in $OldQue; do
		if [[ ! -d /proc/$PID ]] ; then
			GenQue; break
		fi
	done
}

for((i=1; i<=$Njob; i++)); do
	CMD $i &
	PID=$!
	PushQue $PID
	while [[ $Nrun -ge $Nproc ]]; do
		ChkQue
		sleep 1
	done
done
wait


输出示例：
shiyanlou:bashtest/ $ bash mndl.sh                                                                                        [12:06:55]
Job 1 Ijob  sleeping for 2 seconds ...
Job 2 Ijob  sleeping for 1 seconds ...
Job 3 Ijob  sleeping for 5 seconds ...
Job 4 Ijob  sleeping for 5 seconds ...
Job 5 Ijob  sleeping for 5 seconds ...
Job 2 Ijob  exiting ...
Job 1 Ijob  exiting ...
Job 6 Ijob  sleeping for 2 seconds ...
Job 7 Ijob  sleeping for 3 seconds ...
Job 6 Ijob  exiting ...
Job 4 Ijob  exiting ...
Job 5 Ijob  exiting ...
Job 3 Ijob  exiting ...
Job 8 Ijob  sleeping for 3 seconds ...
Job 7 Ijob  exiting ...
Job 9 Ijob  sleeping for 5 seconds ...
Job 10 Ijob  sleeping for 1 seconds ...
Job 10 Ijob  exiting ...
Job 8 Ijob  exiting ...
Job 9 Ijob  exiting ...



一个更简洁的方法是记录PID到数组, 通过检查PID存在与否以确定作业是否运行完毕. 可实现如下

# Language: bash
Njob=10    # 作业数目
Nproc=5    # 可同时运行的最大作业数

function CMD {        # 测试命令, 随机等待几秒钟
	n=$((RANDOM % 5 + 1))
	echo "Job $1 Ijob $2 sleeping for $n seconds ..."
	sleep $n
	echo "Job $1 Ijob $2 exiting ..."
}

PID=() # 记录PID到数组, 检查PID是否存在以确定是否运行完毕
for((i=1; i<=Njob; )); do
	for((Ijob=0; Ijob<Nproc; Ijob++)); do
		if [[ $i -gt $Njob ]]; then
			break;
		fi
		if [[ ! "${PID[Ijob]}" ]] || ! kill -0 ${PID[Ijob]} 2> /dev/null; then  #向进程发送信号，以确认进程是否存在
			CMD $i $Ijob &
			PID[Ijob]=$!
			i=$((i+1))
		fi
	done
	sleep 1
done
wait



输出示例：
shiyanlou:bashtest/ $ bash mndl1.sh                                                                                       [13:39:01]
Job 5 Ijob 4 sleeping for 3 seconds ...
Job 4 Ijob 3 sleeping for 4 seconds ...
Job 2 Ijob 1 sleeping for 2 seconds ...
Job 1 Ijob 0 sleeping for 2 seconds ...
Job 3 Ijob 2 sleeping for 4 seconds ...
Job 1 Ijob 0 exiting ...
Job 2 Ijob 1 exiting ...
Job 5 Ijob 4 exiting ...
Job 6 Ijob 0 sleeping for 5 seconds ...
Job 7 Ijob 1 sleeping for 5 seconds ...
Job 8 Ijob 4 sleeping for 1 seconds ...
Job 3 Ijob 2 exiting ...
Job 4 Ijob 3 exiting ...
Job 9 Ijob 2 sleeping for 2 seconds ...
Job 10 Ijob 3 sleeping for 3 seconds ...
Job 8 Ijob 4 exiting ...
Job 9 Ijob 2 exiting ...
Job 10 Ijob 3 exiting ...
Job 6 Ijob 0 exiting ...
Job 7 Ijob 1 exiting ...
